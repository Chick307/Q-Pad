<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Chrome Pad</title>
	<link rel="stylesheet" type="text/css" href="css/pop.css">
	<script type="text/javascript" src="js/pref.js"></script>
	<script type="text/javascript" src="chui.js"></script>
	<link rel="stylesheet" href="chui.css" />
</head>
<body>
	<div id='share-popup'>
		<iframe src="share.html" id="share-popup-frame"></iframe>
		<div id='share-popup-border-o'>
			<div id='share-popup-border-i'></div>
		</div>
	</div>
	<div id="wrapper">
		<div id="bar"></div>
		<iframe src="pad.html" id="pad" class="border-box"></iframe>
	</div>
	<script type="text/javascript">
		var pref = new Preference({prefix: 'pref-'});
		var bar = document.getElementById('bar');
		
		chui({
			type: 'linear',
			id: 'top-bar',
			contents: [{
				type: 'checkButton',
				id: 'share-button',
				text: 'Share',
				image: {url: 'icons/arrow.png', width: 16, height: 16},
				height: 26,
				onCheck: function(){
					sharePopup.Show();
				},
				onUncheck: function(){
					sharePopup.Hide();
				}
			}, {
				type: 'button',
				id: 'clear-button',
				text: 'Clear',
				image: {url: 'icons/paper.png', width: 16, height: 16},
				height: 26,
				onClick: function(){
					chui($id('share-button')).uncheck();
					Text.Clear();
				}
			}, {
				type: 'tight',
				id: 'paste-button-list',
				contents: [{
					type: 'button',
					id: 'paste-button',
					text: 'Paste Selection',
					height: 26,
					onClick: function(){
						chui($id('share-button')).uncheck();
						PasteSelection('selection');
					}
				}, {
					type: 'button',
					id: 'paste-url-button',
					text: 'Paste URL',
					height: 26,
					onClick: function(){
						chui($id('share-button')).uncheck();
						PasteSelection('url');
					}
				}, {
					type: 'button',
					id: 'paste-title-button',
					text: 'Paste Title',
					height: 26,
					onClick: function(){
						chui($id('share-button')).uncheck();
						PasteSelection('title');
					}
				}]
			}]
		}).appendTo(bar);
		
		chui({
			type: 'linear',
			id: 'top-right-bar',
			contents: [{
				type: 'button',
				id: 'option-button',
				image: {url: 'icons/gear.png', width: 16, height: 16},
				width: 26,
				height: 26,
				onClick: function(){
					chui($id('share-button')).uncheck();
					chrome.tabs.create({
						url: chrome.extension.getURL('/views/option.html'),
						selected: true
					});
					window.close();
				}
			}, {
				type: 'button',
				id: 'maximize-button',
				image: {url: 'icons/maximize.png', width: 16, height: 16},
				width: 26,
				height: 26,
				onClick: function(){
					chui($id('share-button')).uncheck();
					chrome.tabs.create({
						url: chrome.extension.getURL('pop.html#m'),
						selected: true
					});
					window.close();
				}
			}, {
				type: 'button',
				id: 'close-button',
				image: {url: 'icons/cross.png', width: 16, height: 16},
				width: 26,
				height: 26,
				onClick: function(){
					chui($id('share-button')).uncheck();
					window.close();
				}
			}]
		}).appendTo(bar);
		
		var $id = function(id){
			return document.getElementById(id);
		};
		
		var sharePopup = (function(sharePopup){
			sharePopup.addEventListener('click', function(e){
				e.stopPropagation();
			}, false);
			
			return {
				Showed: false,
				Show: function(){
					sharePopup.style.display = this.Showed? 'none': 'block';
					this.Showed = !this.Showed;
				},
				Hide: function(){
					if(this.Showed){
						sharePopup.style.display = 'none';
						this.Showed = false;
					}
				}
			};
		})(document.getElementById('share-popup'));
		
		function ShowHelp(){
			alert([
				'Ctrl + L : Clear',
				'Ctrl + S : Share',
				'Ctrl + P : Paste Selection',
				'Ctrl + T : Paste Title',
				'Ctrl + U : Paste URL',
				'Ctrl + W : Close',
				'Ctrl + / : Show this',
			].join('\n'), 'Keyboard Shortcuts');
		}
		
		if(location.hash == '#m'){
			var html = document.documentElement.style;
			var body = document.body.style;
			html.width = body.width = '100%';
			html.height = body.height = '100%';
			body.borderWidth = '1px 0 0 0';
			
			$id('maximize-button').style.display = 'none';
			$id('paste-button-list').style.display = 'none';
			
			var bar = $id('bar');
			bar.style.left = '1px';
			bar.style.top = '1px';
			bar.style.right = '1px';
		}
		
		// Hide Share Popup
		document.addEventListener('click', function(){
			chui($id('share-button')).uncheck();
		}, false);
		
		// Unable Context-Menu
		document.addEventListener('contextmenu', function(e){
			e.preventDefault();
		}, false);
		
		var pad, padDoc, area;
		
		var Text = {
			Save: function(){
				pref.set('text', area.value);
				pref.set('start', area.selectionStart);
				pref.set('end', area.selectionEnd);
				pref.set('top', area.scrollTop);
				Text.Focus();
			},
			Clear: function(){
				if(area.value == '')
					return;
				if(confirm('Clear Text, OK?')){
					area.value = '';
					Text.Save();
				}
			},
			Insert: function(text){
				var value = new String(area.value);
				var start = area.selectionStart;
				var end = area.selectionEnd;
				
				area.value = value.slice(0, start) + text +
					value.slice(end, value.length);
				area.selectionStart = area.selectionEnd =
					start + text.length;
				
				Text.Save();
			},
			Focus: function(){
				pad.focus();
				area.focus();
			}
		};
		
		var PasteSelection = function(type){
			chrome.tabs.getSelected(null, function(tab){
				if(type === 'url'){
					Text.Insert(tab.url);
				}else if(type === 'title'){
					Text.Insert(tab.title || '');
				}else{
					chrome.tabs.sendRequest(tab.id, {
						method: 'GetSelection',
						params: []
					}, function(selection){
						Text.Insert(selection);
					});
				}
			});
		};
		
		window.addEventListener('load', function(){
			pad = frames[1];
			padDoc = pad.document;
			area = padDoc.getElementById('area');
			
			var fontFamily = pref.get('font-name', 'sans-serif');
			area.style.fontFamily = fontFamily;
			area.style.fontSize = pref.get('font-size', '14px');
			
			if(pad.getComputedStyle(area, '').fontFamily !== fontFamily){
				location.reload();
				return;
			}
			
			area.value = pref.get('text', localStorage['text'] || '');
			area.setSelectionRange(pref.get('start', 0), pref.get('end', 0));
			area.scrollTop = pref.get('top', 0);
			
			// Save Text
			var TextChangeListener = function(e){
				// 非同期にしないとinputイベント時点でのカーソル位置が古いものになる
				window.setTimeout(Text.Save.bind(Text), 0);
			};
			area.addEventListener('input', TextChangeListener, false);
			area.addEventListener('click', TextChangeListener, false);
			area.addEventListener('contextmenu', TextChangeListener, false);
			area.addEventListener('scroll', TextChangeListener, false);
			
			// クリップボードからペースト
			area.addEventListener('paste', function(e){
				Text.Insert(e.clipboardData.getData('Text'));
				e.preventDefault();
			}, false);
			
			// シェアポップアップを隠す
			padDoc.addEventListener('click', function(){
				chui($id('share-button')).uncheck();
			}, false);
		
			// Key Bind
			var keyBind = {
				'Tab': function(){ Text.Insert('\t'); },
				// 'Enter': function(){ Text.Insert('\n'); },
				'Ctrl + L': function(){ Text.Clear(); },
				'Ctrl + S': function(){ sharePopup.Show(); },
				'Ctrl + T': function(){ PasteSelection('title'); },
				'Ctrl + U': function(){ PasteSelection('url'); },
				'Ctrl + P': function(){ PasteSelection('selection'); },
				'Ctrl + W': function(){ window.close(); },
				'Ctrl + /': ShowHelp,
				'Shift + Ctrl + /': ShowHelp
			};
			
			var keyCodeTable = {9: 'Tab', 13: 'Enter', 191: '/'};
			var KeyDownListener = function(e){
				var code = e.keyCode;
				var builder = [];
				if(e.altKey) builder.push('Alt');
				if(e.shiftKey) builder.push('Shift');
				if(e.ctrlKey) builder.push('Ctrl');
				builder.push(keyCodeTable[code] || String.fromCharCode(code));
				
				var key = builder.join(' + ');
				if(key in keyBind){
					keyBind[key]();
					e.preventDefault();
				}
			};
			
			area.addEventListener('keydown', KeyDownListener, false);
			document.addEventListener('keydown', KeyDownListener, false);
			
			pad.focus();
		}, false);
	</script>
</body>
</html>
