<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<title>Chrome Pad</title>
	<link rel="stylesheet" type="text/css" href="css/pop.css">
	<script type="text/javascript" src="js/api.js"></script>
</head>
<body>
	<div id="wrapper">
		<div id="bar">			<ul id="top-bar"><li><button id="share-button">				<img src="icons/arrow.png" width="16" height="16">				<span>Share</span>				<div id='share-popup'>
					<iframe src="share.html" id="share-popup-frame"></iframe>					<div id='share-popup-border-o'>						<div id='share-popup-border-i'></div>					</div>				</div>			</button></li><li><button id="clear-button">				<img src="icons/paper.png" width="16" height="16" />				<span>Clear</span>			</button></li><li><button id="paste-button">				<span>Paste Selection</span>			</button></li><li><button id="paste-url-button">				<span>Paste URL</span>			</button></li><li><button id="paste-title-button">				<span>Paste Title</span>			</button></li></ul>
			<ul id="top-right-bar"><li><button id="option-button">
				<img src="icons/gear.png" width="16" height="16" />
			</button></li><li><button id="maximize-button">
				<img src="icons/maximize.png" width="16" height="16" />
			</button></li><li><button id="close-button">				<img src="icons/cross.png" width="16" height="16" />			</button></li></ul>		</div>		<iframe src="pad.html" id="pad" class="border-box"></iframe>	</div>
	<script type="text/javascript">
		var $id = function(id){
			return document.getElementById(id);
		};
		
		var sharePopup = (function(){
			var sharePopup = document.getElementById('share-popup');
			
			sharePopup.addEventListener('click', function(e){
				e.stopPropagation();
			}, false);
			
			return {
				Showed: false,
				Show: function(){
					sharePopup.style.display = this.Showed? 'none': 'block';
					this.Showed = !this.Showed;
				},
				Hide: function(){
					if(this.Showed){
						sharePopup.style.display = 'none';
						this.Showed = false;
					}
				}
			};
		})();
		
		function ShowHelp(){
			alert([
				'Ctrl + L : Clear',
				'Ctrl + S : Share',
				'Ctrl + P : Paste Selection',
				'Ctrl + T : Paste Title',
				'Ctrl + U : Paste URL',
				'Ctrl + W : Close',
				'Ctrl + / : Show this',
			].join('\n'), 'Keyboard Shortcuts');
		}
		
		if(location.hash == '#m'){
			var html = document.documentElement.style;
			var body = document.body.style;
			html.width = body.width = '100%';
			html.height = body.height = '100%';
			body.borderWidth = '1px 0 0 0';
			
			$id('maximize-button').style.display = 'none';
			$id('paste-button').style.display = 'none';
			$id('paste-url-button').style.display = 'none';
			$id('paste-title-button').style.display = 'none';
			
			var bar = $id('bar');
			bar.style.left = '1px';
			bar.style.top = '1px';
			bar.style.right = '1px';
		}
		
		// Hide Share Popup
		document.addEventListener('click', function(){
			sharePopup.Hide();
		}, false);
		
		// Unable Context-Menu
		document.addEventListener('contextmenu', function(e){
			e.preventDefault();
		}, false);
		
		window.addEventListener('load', function(){
			var pad = frames[1];
			var padDoc = pad.document;
			var area = padDoc.getElementById('area');
			
			var Text = {
				Save: function(){
					api.SetText({
						text: area.value,
						start: area.selectionStart,
						end: area.selectionEnd,
						top: area.scrollTop
					});
					Text.Focus();
				},
				Clear: function(){
					if(area.value == '')
						return;
					if(confirm('Clear Text, OK?')){
						area.value = '';
						actions.SaveText();
					}
				},
				Insert: function(text){
					var value = new String(area.value);
					var start = area.selectionStart;
					var end = area.selectionEnd;
					
					area.value = value.slice(0, start) + text +
						value.slice(end, value.length);
					area.selectionStart = area.selectionEnd =
						start + text.length;
					
					Text.Save();
				},
				Focus: function(){
					pad.focus();
					area.focus();
				}
			};
			
			api.GetPref(function(pref){
				area.style.fontFamily = pref['font-name'];
				area.style.fontSize = pref['font-size'];
			});
			
			api.GetText(function(value){
				area.value = value.text;
				area.setSelectionRange(value.start, value.end);
				area.scrollTop = value.top;
			});
			
			// Save Text
			var TextChangeListener = function(e){
				// 非同期にしないとinputイベント時点でのカーソル位置が古いものになる
				window.setTimeout(function(){
					Text.Save();
				}, 0);
			};
			
			area.addEventListener('input', TextChangeListener, false);
			area.addEventListener('click', TextChangeListener, false);
			area.addEventListener('contextmenu', TextChangeListener, false);
			area.addEventListener('scroll', TextChangeListener, false);
			
			// Paste Clipboard
			area.addEventListener('paste', function(e){
				Text.Insert(e.clipboardData.getData('Text'));
				e.preventDefault();
			}, false);
			
			// Hide Share Popup
			padDoc.addEventListener('click', function(){
				sharePopup.Hide();
			}, false);
			
			$id('share-button').addEventListener('click', function(e){
				if(!sharePopup.Showed)
					e.stopPropagation();
				sharePopup.Show();
			}, false);
			
			$id('clear-button').addEventListener('click', function(){
				sharePopup.Hide();
				Text.Clear();
			}, false);
			
			var PasteSelection = function(type){
				sharePopup.Hide();
				if(type === 'selection')
					api.GetSelection(function(selection){
						Text.Insert(selection);
					});
				else if(type === 'url')
					api.GetSelectedTab(function(tab){
						Text.Insert(tab.url);
					});
				else if(type === 'title')
					api.GetSelectedTab(function(tab){
						Text.Insert(tab.title || '');
					});
			};
			
			$id('paste-button').addEventListener('click', function(){
				PasteSelection('selection');
			}, false);
			
			$id('paste-url-button').addEventListener('click', function(){
				PasteSelection('url');
			});
			
			$id('paste-title-button').addEventListener('click', function(){
				PasteSelection('title');
			});
			
			$id('option-button').addEventListener('click', function(){
				sharePopup.Hide();
				api.CreateTab(chrome.extension.getURL('opt.html'));
				window.close();
			});
			
			$id('maximize-button').addEventListener('click', function(){
				sharePopup.Hide();
				api.CreateTab(chrome.extension.getURL('pop.html#m'));
				window.close();
			});
			
			function CloseWindow(){
				sharePopup.Hide();
				window.close();
			}
			
			$id('close-button').addEventListener('click', function(){
				CloseWindow();
			});
		
			// Key Bind
			var keyBind = {
				'Tab': function(){ Text.Insert('\t'); },
				'Enter': function(){ Text.Insert('\n'); },
				'Ctrl + L': function(){ Text.Clear(); },
				'Ctrl + S': function(){ sharePopup.Show(); },
				'Ctrl + T': function(){ PasteSelection('title'); },
				'Ctrl + U': function(){ PasteSelection('url'); },
				'Ctrl + P': function(){ PasteSelection('selection'); },
				'Ctrl + W': CloseWindow,
				'Ctrl + /': ShowHelp,
				'Shift + Ctrl + /': ShowHelp
			};
			
			var keyCodeTable = {9: 'Tab', 13: 'Enter', 191: '/'};
			var KeyDownListener = function(e){
				var code = e.keyCode;
				var builder = [];
				
				if(e.altKey)
					builder.push('Alt +');
				if(e.shiftKey)
					builder.push('Shift +');
				if(e.ctrlKey)
					builder.push('Ctrl +');
					
				builder.push(keyCodeTable[code] || String.fromCharCode(code));
				
				var key = builder.join(' ');
				
				if(key in keyBind){
					keyBind[key]();
					e.preventDefault();
				}
			};
			
			area.addEventListener('keydown', KeyDownListener, false);
			document.addEventListener('keydown', KeyDownListener, false);
			
			pad.focus();
		}, false);
	</script>
</body>
</html>