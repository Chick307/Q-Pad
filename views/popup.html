<!DOCTYPE html>
<html id="m">
<head>
	<meta charset="utf-8">
	<style>
		html {
			width: 600px;
			height: 372px;
			user-select: none;
			-webkit-user-select: none;
		}

		html.small {
			width: 420px;
			height: 260px;
		}

		html:target {
			width: 100%;
			height: 100%;
		}

		body {
			display: box;
			display: -webkit-box;
			box-orient: vertical;
			-webkit-box-orient: vertical;
			width: 100%;
			height: 100%;
			margin: 0;
		}

		ul {
			display: box;
			display: -webkit-box;
			margin: 0;
			padding: 0 0 1px;
		}

		ul > li {
			position: relative;
			display: block;
			margin: 1px;
			padding: 0;
		}

		ul > li.space {
			box-flex: 1;
			-webkit-box-flex: 1;
		}

		ul > li > button {
			margin: 0;
			padding: 0;
			border-width: 1px;
			border-style: solid;
			border-color: rgba(0, 0, 0, 0.4);
			border-radius: 3px;
			background: -webkit-linear-gradient(top, #FFF, #DDD);
			box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.4);
			text-shadow: 1px 1px 0 #FFF;
			font-family: sans-serif;
			font-size: 12px;
			vertical-align: top;
		}

		ul > li > button:active {
			background: -webkit-linear-gradient(bottom, #EEE, #CCC);
		}

		ul > li > button > img {
			margin: 3px;
			width: 16px;
			height: 16px;
			vertical-align: middle;
		}

		ul > li > button > span {
			display: inline-block;
			margin: 3px;
			padding: 0 0.5em;
			vertical-align: middle;
			line-height: 16px;
		}

		ul > li > button > img + span {
			padding-left: 0;
		}

		body > iframe {
			display: block;
			box-flex: 1;
			-webkit-box-flex: 1;
			border: 1px solid rgba(0, 0, 0, 0.3);
		}

		#black {
			display: none;
			position: absolute;
			top: 0;
			right: 0;
			bottom: 0;
			left: 0;
			background: rgba(255, 255, 255, 0.8);
		}

		#black.visible {
			display: block;
		}

		.dialog {
			display: none;
			box-orient: vertical;
			-webkit-box-orient: vertical;
			position: absolute;
			z-index: 1;
			left: 150px;
			top: 50px;
			width: 300px;
			padding: 8px;
			border: 1px solid rgba(0, 0, 0, 0.4);
			border-radius: 5px;
			background: #FFF;
		}

		html.small .dialog {
			left: 60px;
			top: 30px;
		}

		.dialog.visible {
			display: box;
			display: -webkit-box;
		}

		.dialog > div {
			box-flex: 1;
			-webkit-box-flex: 1;
			padding: 1em;
			text-align: center;
			font-family: sans-serif;
			font-size: 14px;
		}

		.dialog > ul > li {
			margin: 0 6px;
		}

		.dialog > ul > li > button {
			font-size: 14px;
		}

		#share-dialog > ul, #paste-dialog > ul {
			box-orient: vertical;
			-webkit-box-orient: vertical;
		}

		#share-dialog > ul > li, #paste-dialog > ul > li {
			margin: 4px;
		}

		#share-dialog > ul > li > button, #paste-dialog > ul > li > button {
			padding: 2px;
			width: 100%;
		}

		#share-dialog > ul > li > button > span {
			padding: 0 0.5em;
		}

		#share-dialog > ul > li > button > img {
			width: 24px;
			height: 24px;
		}

		html:target #paste-button,
		html:target #maximize-button {
			display: none;
		}

		html:target > body > ul {
			padding: 1px;
		}

		html:target > body > iframe {
			border-width: 1px 0 0 0;
		}

		ul > li > button:focus {
			outline: none;
			box-shadow: 0 0 2px 2px rgba(255, 192, 0, 0.6);
		}
	</style>
</head>
<body>
	<ul>
		<li><button id="share-button">
			<img src="/icons/arrow.png" alt="">
			<span>Share</span>
		</button>
		<li><button id="clear-button">
			<img src="/icons/paper.png" alt="">
			<span>Clear</span>
		</button>
		<li><button id="paste-button">
			<span>Paste</span>
		</button>
		<li class="space">
		<li><button id="maximize-button">
			<img src="/icons/maximize.png" alt="">
		</button>
		<li><button id="option-button">
			<img src="/icons/gear.png" alt="">
		</button>
		<li><button id="close-button">
			<img src="/icons/cross.png" alt="">
		</button>
	</ul>

	<iframe src="textarea.html"></iframe>

	<div id="black">
		<div id="share-dialog" class="dialog">
			<ul>
				<li><button id="share-cancel"><span>Cancel</span></button>
			</ul>
		</div>
		<div class="dialog" id="clear-dialog">
			<div>Clear all text</div>
			<ul>
				<li class="space">
				<li><button id="clear-cancel"><span>Cancel</span></button>
				<li><button id="clear-ok"><span>OK</span></button>
				<li class="space">
			</ul>
		</div>
		<div id="paste-dialog" class="dialog">
			<ul>
				<li><button id="paste-url"><span>Paste URL</span></button>
				<li><button id="paste-title"><span>Paste Title</span></button>
				<li><button id="paste-selection"><span>Paste Selection</span></button>
				<li><button id="paste-cancel"><span>Cancel</span></button>
			</ul>
		</div>
	</div>

	<script>
		var backgroundPage = chrome.extension.getBackgroundPage();
		var pref = backgroundPage.pref;

		var popupSize = pref.get('popup-size', '1');
		if(!location.hash){
			switch(popupSize){
				case '0':
					Q('html').classList.add('small');
					break;
				case '2':
					open(chrome.extension.getURL('views/popup.html') + '#m');
					close();
			}
		}

		window.addEventListener('load', function(){
			var frame = Q('iframe');
			var textarea = frame.contentWindow;
			textarea.focus();


			document.addEventListener('click', function(){
				textarea.focus();
			}, false);


			Q('#black').addEventListener('click', function(e){
				e.preventDefault();
				e.stopPropagation();
			}, false);

			Q('#black').addEventListener('keydown', function(e){
				if(e.keyIdentifier === 'U+001B'){
					if(Q('#share-dialog.visible')){
						click('#share-cancel');
					}else if(Q('#clear-dialog.visible')){
						click('#clear-cancel');
					}else if(Q('#paste-dialog.visible')){
						click('#paste-cancel');
					}
				}
			}, false);


			Q('#share-button').addEventListener('click', function(){
				Q('#black').classList.add('visible');
				Q('#share-dialog').classList.add('visible');
				Q('#share-dialog button').focus();
			}, false);

			Q('#share-cancel').addEventListener('click', function(){
				textarea.focus();
				Q('#share-dialog').classList.remove('visible');
				Q('#black').classList.remove('visible');
			}, false);

			Q('#share-cancel').addEventListener('keydown', function(event){
				if(event.keyIdentifier === 'Up'){
					Q('#share-dialog li:nth-last-child(2) > button').focus();
					event.preventDefault();
				}
			}, false);


			Q('#clear-button').addEventListener('click', function(){
				Q('#black').classList.add('visible');
				Q('#clear-dialog').classList.add('visible');
				Q('#clear-cancel').focus();
			}, false);

			Q('#clear-cancel').addEventListener('click', function(){
				textarea.focus();
				Q('#clear-dialog').classList.remove('visible');
				Q('#black').classList.remove('visible');
			}, false);

			Q('#clear-cancel').addEventListener('keydown', function(event){
				if(event.keyIdentifier === 'Right'){
					Q('#clear-ok').focus();
					event.preventDefault();
				}
			}, false);

			Q('#clear-ok').addEventListener('click', function(){
				textarea.clear();
				textarea.save();
				textarea.focus();
				Q('#clear-dialog').classList.remove('visible');
				Q('#black').classList.remove('visible');
			}, false);

			Q('#clear-ok').addEventListener('keydown', function(event){
				if(event.keyIdentifier === 'Left'){
					Q('#clear-cancel').focus();
					event.preventDefault();
				}
			}, false);


			Q('#paste-button').addEventListener('click', function(){
				Q('#black').classList.add('visible');
				Q('#paste-dialog').classList.add('visible');
			}, false);

			Q('#paste-url').addEventListener('click', function(){
				chrome.tabs.getSelected(null, function(tab){
					textarea.insert(tab.url);
				});
				textarea.focus();
				Q('#paste-dialog').classList.remove('visible');
				Q('#black').classList.remove('visible');
			}, false);

			Q('#paste-title').addEventListener('click', function(){
				chrome.tabs.getSelected(null, function(tab){
					textarea.insert(tab.title || '');
				});
				textarea.focus();
				Q('#paste-dialog').classList.remove('visible');
				Q('#black').classList.remove('visible');
			}, false);

			Q('#paste-selection').addEventListener('click', function(){
				chrome.tabs.getSelected(null, function(tab){
					chrome.tabs.sendRequest(tab.id, {
						method: 'GetSelection',
						params: []
					}, function(selection){
						textarea.insert(selection);
					});
				});
				textarea.focus();
				Q('#paste-dialog').classList.remove('visible');
				Q('#black').classList.remove('visible');
			}, false);

			Q('#paste-cancel').addEventListener('click', function(){
				textarea.focus();
				Q('#paste-dialog').classList.remove('visible');
				Q('#black').classList.remove('visible');
			}, false);


			Q('#maximize-button').addEventListener('click', function(){
				window.open(
					chrome.extension.getURL('/views/popup.html') + '#m');
				close();
			}, false);

			Q('#option-button').addEventListener('click', function(){
				window.open(chrome.extension.getURL('/views/option.html'));
				if(!Q('html:target'))
					close();
			}, false);

			Q('#close-button').addEventListener('click', function(){
				close();
			}, false);

			var fragment = document.createDocumentFragment();
			backgroundPage.externalServices.forEach(function(service){
				var item = document.createElement('li');
				item.style.fontSize = '16px';
				var button = document.createElement('button');
				var image = document.createElement('img');
				image.src = service.icon;
				var name = document.createElement('span');
				name.textContent = service.name;
				button.appendChild(image);
				button.appendChild(name);
				item.appendChild(button);
				fragment.appendChild(item);

				button.addEventListener('click', function(){
					service.callback(pref.get('text', ''));
					if(!Q('html:target'))
						close();
				}, false);

				button.addEventListener('keydown', function(event){
					var sibling;

					if(event.keyIdentifier === 'Up'){
						sibling = item.previousElementSibling;
					}else if(event.keyIdentifier === 'Down'){
						sibling = item.nextElementSibling;
					}

					if(sibling)
						sibling.querySelector('button').focus();
				}, false);
			});
			var shareList = Q('#share-dialog > ul');
			shareList.insertBefore(fragment, shareList.firstElementChild);
		});

		function Q(selector){
			return document.querySelector(selector);
		}

		function click(selector){
			var event = document.createEvent('Event');
			event.initEvent('click', false, false);
			Q(selector).dispatchEvent(event);
		}
	</script>
</body>
</html>

